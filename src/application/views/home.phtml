<?php if (FALSE == $this->user) : ?>
<div class="col-sm-4 col-sm-offset-4" id="connexion">
    <h1 class="text-center">Login</h1>
    <?php if (!empty($this->errMessages)) : ?>
    	<ul class="list-group" id="erreurs">
    	<?php foreach ($this->errMessages as $value) : ?>
			<li class="list-group-item list-group-item-danger"><?= $value ?></li>
    	<?php endforeach; ?>
    	</ul>
	<?php endif; ?>
	    <form role="form" method="POST" action="">
	    	<div class="form-group">
	    		<label for="login">Login : </label>
	    		<input name="login" id="login" type="text" class="form-control" <?php if(isset($this->inputs)) : ?>value="<?= $this->inputs['login']?>"<?php endif; ?>/>
	    	</div>
	    	<div class="form-group">
	    		<label for="password">Password : </label>
	    		<input name="password" id="password" type="password" class="form-control" <?php if(isset($this->inputs)) : ?>value="<?= $this->inputs['password']?>"<?php endif; ?>/>
	    	</div>
	       <input name="connect" id="connect" type="Submit" class="btn btn-default btn-sm"/>
	    </form>
	    <p class="text-right"><a href="">Mot de passe oublié ?</a></p>
	    <br>
</div>	    
<?php else : ?>
	<p class="hidden" id="id_client"><?= $this->user['id'] ?></p>
    <h1>Bienvenue <?= $this->user['pseudo'] ?></h1>
    <?php if($this->user['profil'] != 'Admin') : ?>
    <table class="table table-striped table-responsive table-condensed">
    	<thead>
    		<th class="hidden">Code</th>
    		<th>Libellé</th>
			<th>Famille</th>
			<th>Labo</th>
			<th>Prix catalogue</th>
			<th>Prix net</th>
			<th>Nombre de produits par colis</th>
			<th>Quantité de colis</th>
			<th>Total produits</th>
			<th>Total prix</th>
			<th>Actions</th>
    	</thead>
    	<tbody>
    	<?php foreach ($this->produits as $produit) : ?>
    		<tr>
    			<td class="hidden" id="id"><?= $produit['id']; ?></td>
    			<td><?= $produit['lib_prd']; ?></td>
    			<td><?= $produit['lib']; ?></td>
    			<td><?= $produit['nom_lab']; ?></td>
    			<td><?= $produit['prx_cat']; ?></td>
    			<td id="prx"><?= $produit['prx_net']; ?></td>
    			<td id="colis"><?= $produit['nbp_col']; ?></td>
    			<td id="input"><input type="text" class="form-control qte" id="qte<?= $produit['id']; ?>" name="qte" /></td>
    			<td id="tot_prd"></td>
    			<td id="tot_prx"></td>
    			<td><input type="button" class="btn btn-default btn-sm command" id="command<?= $produit['id']; ?>" name="command" value="Ajouter au panier"/></td>
    		</tr>
    	<?php endforeach; ?>
    	</tbody>
    </table>
    <div class="text-alert text-center" id="alerte"></div>
	<?php endif; ?>
<?php endif; ?>

<script type="text/javascript">
	$(".qte").keyup(function(e) {
		var elmt = $(e.target.parentNode).context;
		var tot_qte = elmt.nextElementSibling;
		var colis = elmt.previousElementSibling;
		var tot_prx = tot_qte.nextElementSibling;
		var prx_net = colis.previousElementSibling;

		var tot_prd = parseInt(colis.innerHTML) * parseInt($(e.target).val());
		if(isNaN(tot_prd)) {
			tot_prd = 0;
		}
		tot_qte.innerHTML = tot_prd;

		var net = parseFloat(prx_net.innerHTML);
		tot_prx.innerHTML = net * tot_prd;
	});

	$("input.command").click(function(e) {
		var elmt = $(e.target.parentNode.parentNode).context;
		var id = elmt.children['id'].innerHTML;
		var quantite = elmt.children['input'];
		if(OnNumber(quantite.firstChild.id)) {
			var produit = {
					'id_prd' : elmt.children['id'].innerHTML,
					'qte'    : elmt.children['input'].firstChild.value
			};
			$.ajax({
			  url      : "/panier?context=html",
			  type     : "POST",
			  dataType : "json",
			  data     : produit,
			  success  : function(result) {
				  alert(result['message']);
			  }// end success
			});
		}
	});
</script>
